{% extends "base.html" %}

{% block title %}الرسائل - فلو ماركت{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="section-header mb-4">
        <h2 class="section-title">📩 الرسائل</h2>
        <button class="btn btn-primary" id="newMessageBtn">
            <i class="fas fa-plus"></i> رسالة جديدة
        </button>
    </div>
    
    <div class="messages-container">
        <div class="conversations-list">
            <div id="conversationsContainer">
                <!-- ستتم إضافة المحادثات هنا جافاسكريبت -->
            </div>
        </div>
        
        <div class="chat-container hidden" id="chatContainer">
            <div class="chat-header">
                <h3 id="chatRecipient">اختر محادثة لبدء الشات</h3>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- ستتم إضافة الرسائل هنا جافاسكريبت -->
            </div>
            
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="اكتب رسالتك هنا...">
                <button class="btn-send" id="sendMessageBtn">
                    <i class="fas fa-paper-plane"></i> إرسال
                </button>
            </div>
        </div>
        
        <div class="welcome-message" id="welcomeMessage">
            <div class="text-center py-5">
                <i class="fas fa-comments fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">مرحباً بك في نظام الرسائل</h4>
                <p class="text-muted">اختر محادثة من القائمة أو ابدأ محادثة جديدة</p>
                <a href="{{ url_for('products') }}" class="btn btn-primary">
                    <i class="fas fa-shopping-bag"></i> تصفح المنتجات
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// تحويل بيانات الرسائل من الخادم إلى JavaScript
const serverMessages = {{ messages | tojson | safe }};
let conversations = {};
let currentConversation = null;
let unreadCount = 0;

// تنظيم الرسائل حسب المحادثات
function organizeConversations() {
    conversations = {};
    
    serverMessages.forEach(msg => {
        const key = `${msg.product_id}_${msg.sender_id === {{ current_user.id }} ? msg.receiver_id : msg.sender_id}`;
        
        if (!conversations[key]) {
            conversations[key] = {
                id: key,
                productId: msg.product_id,
                productName: msg.product_name,
                otherUserId: msg.sender_id === {{ current_user.id }} ? msg.receiver_id : msg.sender_id,
                otherUserName: msg.sender_id === {{ current_user.id }} ? msg.receiver_name : msg.sender_name,
                messages: []
            };
        }
        
        conversations[key].messages.push({
            id: msg.id,
            sender: msg.sender_id === {{ current_user.id }} ? 'me' : 'other',
            senderName: msg.sender_name,
            content: msg.content,
            time: new Date(msg.timestamp).toLocaleTimeString('ar-EG', { 
                hour: '2-digit', 
                minute: '2-digit' 
            }),
            timestamp: new Date(msg.timestamp),
            isRead: msg.is_read
        });
    });
    
    // ترتيب الرسائل حسب الوقت
    Object.values(conversations).forEach(conv => {
        conv.messages.sort((a, b) => a.timestamp - b.timestamp);
    });
}

// عرض قائمة المحادثات
function renderConversations() {
    const container = document.getElementById('conversationsContainer');
    container.innerHTML = '';
    
    const convArray = Object.values(conversations);
    
    if (convArray.length === 0) {
        container.innerHTML = `
            <div class="no-conversations">
                <p class="text-muted text-center">لا توجد محادثات بعد</p>
            </div>
        `;
        return;
    }
    
    convArray.forEach(conv => {
        const lastMessage = conv.messages[conv.messages.length - 1];
        const unreadInConv = conv.messages.filter(msg => !msg.isRead && msg.sender === 'other').length;
        
        const conversationEl = document.createElement('div');
        conversationEl.classList.add('conversation');
        if (currentConversation?.id === conv.id) conversationEl.classList.add('active');
        
        conversationEl.innerHTML = `
            <div class="conversation-avatar">${conv.otherUserName.charAt(0)}</div>
            <div class="conversation-info">
                <div class="conversation-header">
                    <div class="conversation-name">${conv.otherUserName}</div>
                    <div class="conversation-time">${lastMessage.time}</div>
                </div>
                <div class="product-info">${conv.productName}</div>
                <div class="last-message">${lastMessage.content}</div>
            </div>
            ${unreadInConv > 0 ? `<div class="unread-count">${unreadInConv}</div>` : ''}
        `;
        
        conversationEl.addEventListener('click', () => {
            selectConversation(conv);
        });
        
        container.appendChild(conversationEl);
    });
}

// اختيار محادثة
function selectConversation(conv) {
    currentConversation = conv;
    renderChat();
    
    document.getElementById('chatContainer').classList.remove('hidden');
    document.getElementById('welcomeMessage').style.display = 'none';
    
    document.querySelectorAll('.conversation').forEach(c => c.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    // وضع علامة مقروء على الرسائل
    conv.messages.forEach(msg => {
        if (msg.sender === 'other') msg.isRead = true;
    });
    
    updateNotificationBadge();
    renderConversations();
}

// عرض محتوى المحادثة
function renderChat() {
    if (!currentConversation) return;
    
    const container = document.getElementById('chatMessages');
    const recipientEl = document.getElementById('chatRecipient');
    
    container.innerHTML = '';
    recipientEl.textContent = `المحادثة مع: ${currentConversation.otherUserName}`;
    
    currentConversation.messages.forEach(msg => {
        const messageEl = document.createElement('div');
        messageEl.classList.add('message');
        messageEl.classList.add(msg.sender === 'me' ? 'buyer' : 'seller');
        
        messageEl.innerHTML = `
            <div class="message-sender">${msg.sender === 'me' ? 'أنت' : msg.senderName}</div>
            <div class="message-content">${msg.content}</div>
            <div class="message-time">${msg.time}</div>
        `;
        
        container.appendChild(messageEl);
    });
    
    // التمرير إلى آخر رسالة
    container.scrollTop = container.scrollHeight;
}

// إرسال رسالة جديدة
function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message || !currentConversation) return;
    
    // إرسال عبر API
    fetch('/send_message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'receiver_id': currentConversation.otherUserId,
            'product_id': currentConversation.productId,
            'content': message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // إضافة الرسالة محلياً
            const now = new Date();
            const newMessage = {
                id: Date.now(),
                sender: 'me',
                senderName: '{{ current_user.fullname }}',
                content: message,
                time: now.toLocaleTimeString('ar-EG', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }),
                timestamp: now,
                isRead: false
            };
            
            currentConversation.messages.push(newMessage);
            renderChat();
            renderConversations();
            input.value = '';
        } else {
            alert('حدث خطأ في إرسال الرسالة');
        }
    });
}

// تحديث شارة الإشعارات
function updateNotificationBadge() {
    unreadCount = Object.values(conversations).reduce((total, conv) => {
        return total + conv.messages.filter(msg => !msg.isRead && msg.sender === 'other').length;
    }, 0);
    
    const badge = document.getElementById('messageCount');
    const badgeContainer = document.getElementById('messagesBadge');
    
    if (badge && badgeContainer) {
        badge.textContent = unreadCount;
        badgeContainer.style.display = unreadCount > 0 ? 'block' : 'none';
    }
}

// رسالة جديدة
document.getElementById('newMessageBtn').addEventListener('click', () => {
    alert('لبدء محادثة جديدة، اذهب إلى صفحة المنتج واضغط على "شات مع البائع"');
});

// إرسال الرسالة
document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);

// إرسال بالضغط على Enter
document.getElementById('messageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

// تهيئة الصفحة
document.addEventListener('DOMContentLoaded', function() {
    organizeConversations();
    renderConversations();
    updateNotificationBadge();
    
    if (Object.keys(conversations).length === 0) {
        document.getElementById('welcomeMessage').style.display = 'block';
        document.getElementById('chatContainer').classList.add('hidden');
    }
});
</script>
{% endblock %}