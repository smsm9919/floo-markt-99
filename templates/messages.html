{% extends "base.html" %}

{% block title %}Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ - ÙÙ„Ùˆ Ù…Ø§Ø±ÙƒØª{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="section-header mb-4">
        <h2 class="section-title">ğŸ“© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h2>
        <button class="btn btn-primary" id="newMessageBtn">
            <i class="fas fa-plus"></i> Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </button>
    </div>
    
    <div class="messages-container">
        <div class="conversations-list">
            <div id="conversationsContainer">
                <!-- Ø³ØªØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù‡Ù†Ø§ Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
            </div>
        </div>
        
        <div class="chat-container hidden" id="chatContainer">
            <div class="chat-header">
                <h3 id="chatRecipient">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø´Ø§Øª</h3>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- Ø³ØªØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù‡Ù†Ø§ Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
            </div>
            
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
                <button class="btn-send" id="sendMessageBtn">
                    <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„
                </button>
            </div>
        </div>
        
        <div class="welcome-message" id="welcomeMessage">
            <div class="text-center py-5">
                <i class="fas fa-comments fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h4>
                <p class="text-muted">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</p>
                <a href="{{ url_for('products') }}" class="btn btn-primary">
                    <i class="fas fa-shopping-bag"></i> ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø¥Ù„Ù‰ JavaScript
const serverMessages = {{ messages | tojson | safe }};
let conversations = {};
let currentConversation = null;
let unreadCount = 0;

// ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
function organizeConversations() {
    conversations = {};
    
    serverMessages.forEach(msg => {
        const key = `${msg.product_id}_${msg.sender_id === {{ current_user.id }} ? msg.receiver_id : msg.sender_id}`;
        
        if (!conversations[key]) {
            conversations[key] = {
                id: key,
                productId: msg.product_id,
                productName: msg.product_name,
                otherUserId: msg.sender_id === {{ current_user.id }} ? msg.receiver_id : msg.sender_id,
                otherUserName: msg.sender_id === {{ current_user.id }} ? msg.receiver_name : msg.sender_name,
                messages: []
            };
        }
        
        conversations[key].messages.push({
            id: msg.id,
            sender: msg.sender_id === {{ current_user.id }} ? 'me' : 'other',
            senderName: msg.sender_name,
            content: msg.content,
            time: new Date(msg.timestamp).toLocaleTimeString('ar-EG', { 
                hour: '2-digit', 
                minute: '2-digit' 
            }),
            timestamp: new Date(msg.timestamp),
            isRead: msg.is_read
        });
    });
    
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª
    Object.values(conversations).forEach(conv => {
        conv.messages.sort((a, b) => a.timestamp - b.timestamp);
    });
}

// Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
function renderConversations() {
    const container = document.getElementById('conversationsContainer');
    container.innerHTML = '';
    
    const convArray = Object.values(conversations);
    
    if (convArray.length === 0) {
        container.innerHTML = `
            <div class="no-conversations">
                <p class="text-muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø¹Ø¯</p>
            </div>
        `;
        return;
    }
    
    convArray.forEach(conv => {
        const lastMessage = conv.messages[conv.messages.length - 1];
        const unreadInConv = conv.messages.filter(msg => !msg.isRead && msg.sender === 'other').length;
        
        const conversationEl = document.createElement('div');
        conversationEl.classList.add('conversation');
        if (currentConversation?.id === conv.id) conversationEl.classList.add('active');
        
        conversationEl.innerHTML = `
            <div class="conversation-avatar">${conv.otherUserName.charAt(0)}</div>
            <div class="conversation-info">
                <div class="conversation-header">
                    <div class="conversation-name">${conv.otherUserName}</div>
                    <div class="conversation-time">${lastMessage.time}</div>
                </div>
                <div class="product-info">${conv.productName}</div>
                <div class="last-message">${lastMessage.content}</div>
            </div>
            ${unreadInConv > 0 ? `<div class="unread-count">${unreadInConv}</div>` : ''}
        `;
        
        conversationEl.addEventListener('click', () => {
            selectConversation(conv);
        });
        
        container.appendChild(conversationEl);
    });
}

// Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§Ø¯Ø«Ø©
function selectConversation(conv) {
    currentConversation = conv;
    renderChat();
    
    document.getElementById('chatContainer').classList.remove('hidden');
    document.getElementById('welcomeMessage').style.display = 'none';
    
    document.querySelectorAll('.conversation').forEach(c => c.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ù…Ù‚Ø±ÙˆØ¡ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    conv.messages.forEach(msg => {
        if (msg.sender === 'other') msg.isRead = true;
    });
    
    updateNotificationBadge();
    renderConversations();
}

// Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
function renderChat() {
    if (!currentConversation) return;
    
    const container = document.getElementById('chatMessages');
    const recipientEl = document.getElementById('chatRecipient');
    
    container.innerHTML = '';
    recipientEl.textContent = `Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹: ${currentConversation.otherUserName}`;
    
    currentConversation.messages.forEach(msg => {
        const messageEl = document.createElement('div');
        messageEl.classList.add('message');
        messageEl.classList.add(msg.sender === 'me' ? 'buyer' : 'seller');
        
        messageEl.innerHTML = `
            <div class="message-sender">${msg.sender === 'me' ? 'Ø£Ù†Øª' : msg.senderName}</div>
            <div class="message-content">${msg.content}</div>
            <div class="message-time">${msg.time}</div>
        `;
        
        container.appendChild(messageEl);
    });
    
    // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
    container.scrollTop = container.scrollHeight;
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message || !currentConversation) return;
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± API
    fetch('/send_message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'receiver_id': currentConversation.otherUserId,
            'product_id': currentConversation.productId,
            'content': message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
            const now = new Date();
            const newMessage = {
                id: Date.now(),
                sender: 'me',
                senderName: '{{ current_user.fullname }}',
                content: message,
                time: now.toLocaleTimeString('ar-EG', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }),
                timestamp: now,
                isRead: false
            };
            
            currentConversation.messages.push(newMessage);
            renderChat();
            renderConversations();
            input.value = '';
        } else {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
        }
    });
}

// ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
function updateNotificationBadge() {
    unreadCount = Object.values(conversations).reduce((total, conv) => {
        return total + conv.messages.filter(msg => !msg.isRead && msg.sender === 'other').length;
    }, 0);
    
    const badge = document.getElementById('messageCount');
    const badgeContainer = document.getElementById('messagesBadge');
    
    if (badge && badgeContainer) {
        badge.textContent = unreadCount;
        badgeContainer.style.display = unreadCount > 0 ? 'block' : 'none';
    }
}

// Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
document.getElementById('newMessageBtn').addEventListener('click', () => {
    alert('Ù„Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø´Ø§Øª Ù…Ø¹ Ø§Ù„Ø¨Ø§Ø¦Ø¹"');
});

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);

// Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
document.getElementById('messageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    organizeConversations();
    renderConversations();
    updateNotificationBadge();
    
    if (Object.keys(conversations).length === 0) {
        document.getElementById('welcomeMessage').style.display = 'block';
        document.getElementById('chatContainer').classList.add('hidden');
    }
});
</script>
{% endblock %}