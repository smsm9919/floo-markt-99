{% extends "base.html" %}
{% block content %}
<div class="product-details">
    <div class="left">
        <img src="{{ product['image_url'] }}" alt="{{ product['name'] }}">
    </div>
    <div class="right">
        <h1>{{ product['name'] }}</h1>
        <p class="cat">{{ product['category_name'] }}</p>
        <p class="desc">{{ product['description'] }}</p>
        <h2 class="price">{{ "{:,.0f}".format(product['price']) }} جنيه</h2>
        <p class="owner">البائع: {{ product['fullname'] }}</p>
        
        {% if current_user.is_authenticated and current_user.id != product.user_id %}
        <!-- Price Negotiation Section -->
        <div class="price-negotiation" id="negotiationSection">
            <h3>تفاوض على السعر</h3>
            <div class="price-slider-container">
                <label for="priceSlider">اقترح سعرك:</label>
                <div class="slider-wrapper">
                    <input type="range" 
                           id="priceSlider" 
                           min="{{ (product['price'] * 0.3)|round|int }}" 
                           max="{{ product['price'] }}" 
                           value="{{ (product['price'] * 0.8)|round|int }}" 
                           class="price-slider">
                    <div class="price-display">
                        <span id="proposedPrice">{{ (product['price'] * 0.8)|round|int }}</span> جنيه
                    </div>
                </div>
                <div class="price-range-labels">
                    <span>{{ (product['price'] * 0.3)|round|int }}</span>
                    <span>{{ product['price'] }}</span>
                </div>
            </div>
            
            <div class="negotiation-form">
                <textarea id="negotiationMessage" 
                          placeholder="أضف رسالة (اختياري)" 
                          maxlength="500"></textarea>
                <button id="sendNegotiation" class="btn btn-primary">
                    <i class="fas fa-handshake"></i> إرسال عرض السعر
                </button>
            </div>
            
            <div id="negotiationResult" class="negotiation-result"></div>
        </div>
        {% elif current_user.is_authenticated %}
        <div class="owner-message">
            <p><i class="fas fa-info-circle"></i> هذا منتجك الخاص</p>
            {% if current_user.role == 'admin' %}
            <div class="admin-controls">
                <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn btn-warning">
                    <i class="fas fa-edit"></i> تعديل المنتج
                </a>
                <a href="{{ url_for('delete_product', product_id=product.id) }}" 
                   class="btn btn-danger"
                   onclick="return confirm('هل أنت متأكد من حذف هذا المنتج؟')">
                    <i class="fas fa-trash"></i> حذف المنتج
                </a>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="login-prompt">
            <p>سجل دخولك للتفاوض على السعر</p>
            <a href="{{ url_for('login') }}" class="btn btn-primary">تسجيل الدخول</a>
        </div>
        {% endif %}
        
        <!-- Simple Chat Section - Show only for non-owners -->
        {% if current_user.is_authenticated and current_user.id != product.user_id %}
        <div class="simple-chat-section" style="margin-top: 30px;">
            <h4>💬 شات مع البائع</h4>
            
            <!-- Chat Messages Display -->
            <div class="chat-box" style="border: 1px solid #ddd; padding: 20px; height: 300px; overflow-y: auto; background: #f9f9f9; margin: 15px 0;">
                {% for message in chat_messages %}
                <div class="message {% if message.sender_id == product.user_id %}seller{% else %}buyer{% endif %}" style="margin: 10px 0; padding: 8px; border-radius: 8px;">
                    {% if message.sender_id == product.user_id %}
                    <div style="background: #d4f9d4; color: #2d5016; padding: 10px; border-radius: 8px;">
                        🟢 البائع: {{ message.message }}
                    </div>
                    {% else %}
                    <div style="background: #ffd6d6; color: #8b0000; padding: 10px; border-radius: 8px;">
                        🔴 المشتري: {{ message.message }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                
                {% if not chat_messages %}
                <p style="text-align: center; color: #666; margin-top: 100px;">لا توجد رسائل بعد. ابدأ المحادثة!</p>
                {% endif %}
            </div>
            
            <!-- Simple Message Form -->
            <form method="POST" action="{{ url_for('send_simple_message') }}" style="display: flex; gap: 10px;">
                <input type="hidden" name="product_id" value="{{ product.id }}">
                <input type="hidden" name="receiver_id" value="{{ product.user_id }}">
                <input type="text" name="content" placeholder="اكتب رسالتك هنا..." required style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <button type="submit" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">📩 إرسال</button>
            </form>
            
            <!-- Phone Contact -->
            {% if product.get('phone') %}
            <div style="margin-top: 15px;">
                <a href="tel:{{ product.get('phone') }}" class="btn btn-info">
                    <i class="fas fa-phone"></i> 📞 اتصال بالبائع
                </a>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Contact Seller Modal -->
<div class="modal fade" id="contactSellerModal" tabindex="-1" aria-labelledby="contactSellerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contactSellerModalLabel">
                    📩 مراسلة البائع: {{ product['fullname'] }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="contactSellerForm">
                    <input type="hidden" id="productId" value="{{ product.id }}">
                    <input type="hidden" id="sellerId" value="{{ product.user_id }}">
                    
                    <div class="mb-3">
                        <label for="buyerName" class="form-label">الاسم</label>
                        <input type="text" class="form-control" id="buyerName" required 
                               {% if current_user.is_authenticated %}
                               value="{{ current_user.fullname }}" readonly style="background-color: #f8f9fa;"
                               {% else %}
                               placeholder="اكتب اسمك"
                               {% endif %}>
                    </div>
                    
                    <div class="mb-3">
                        <label for="buyerEmail" class="form-label">البريد الإلكتروني</label>
                        <input type="email" class="form-control" id="buyerEmail" required 
                               {% if current_user.is_authenticated %}
                               value="{{ current_user.email }}" readonly style="background-color: #f8f9fa;"
                               {% else %}
                               placeholder="example@email.com"
                               {% endif %}>
                    </div>
                    
                    <div class="mb-3">
                        <label for="messageText" class="form-label">الرسالة</label>
                        <textarea class="form-control" id="messageText" rows="4" required placeholder="اكتب رسالتك للبائع هنا..."></textarea>
                    </div>
                </form>
                <div id="contactResult"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" id="sendContactMessage">
                    <i class="fas fa-paper-plane"></i> إرسال الرسالة
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Real-Time Chat Modal -->
<div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chatModalLabel">
                    <i class="fas fa-comments"></i> دردشة مع {{ product['fullname'] }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="chatContainer" class="chat-container">
                    <div id="chatMessages" class="chat-messages"></div>
                    <div class="chat-input-container">
                        <div class="input-group">
                            <input type="text" id="chatInput" class="form-control" placeholder="اكتب رسالتك..." maxlength="500">
                            <button class="btn btn-primary" id="sendChatMessage">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chat-container {
    height: 400px;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 10px;
    margin-bottom: 15px;
    direction: rtl;
}

.chat-message {
    margin-bottom: 15px;
    display: flex;
    align-items: flex-start;
}

.chat-message.own-message {
    justify-content: flex-end;
}

.chat-message.other-message {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 18px;
    word-wrap: break-word;
    position: relative;
}

.chat-message.own-message .message-bubble {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    margin-left: 15px;
}

.chat-message.other-message .message-bubble {
    background: #ffffff;
    color: #333;
    border: 1px solid #dee2e6;
    margin-right: 15px;
}

.message-meta {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 5px;
}

.chat-input-container {
    direction: rtl;
}

.chat-input-container .input-group {
    direction: rtl;
}

.chat-input-container input {
    text-align: right;
    direction: rtl;
}

.no-messages {
    text-align: center;
    color: #666;
    padding: 50px 20px;
    font-style: italic;
}

.chat-loading {
    text-align: center;
    padding: 20px;
    color: #666;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const priceSlider = document.getElementById('priceSlider');
    const proposedPriceDisplay = document.getElementById('proposedPrice');
    const sendButton = document.getElementById('sendNegotiation');
    const messageTextarea = document.getElementById('negotiationMessage');
    const resultDiv = document.getElementById('negotiationResult');
    
    if (priceSlider) {
        // Update price display when slider moves
        priceSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            proposedPriceDisplay.textContent = value.toLocaleString();
            
            // Change color based on percentage of original price
            const originalPrice = {{ product['price'] }};
            const percentage = (value / originalPrice) * 100;
            
            if (percentage < 50) {
                this.style.background = '#ff4757';
            } else if (percentage < 75) {
                this.style.background = '#ffa502';
            } else {
                this.style.background = '#2ed573';
            }
        });
        
        // Send negotiation
        sendButton.addEventListener('click', function() {
            const proposedPrice = parseInt(priceSlider.value);
            const message = messageTextarea.value.trim();
            
            // Disable button during request
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
            
            fetch('/api/negotiate_price', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: {{ product['id'] }},
                    offered_price: proposedPrice,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> ${data.message}
                        </div>
                    `;
                    sendButton.innerHTML = '<i class="fas fa-check"></i> تم الإرسال';
                    setTimeout(() => {
                        sendButton.innerHTML = '<i class="fas fa-handshake"></i> إرسال عرض السعر';
                        sendButton.disabled = false;
                    }, 3000);
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-error">
                            <i class="fas fa-exclamation-circle"></i> ${data.message}
                        </div>
                    `;
                    sendButton.innerHTML = '<i class="fas fa-handshake"></i> إرسال عرض السعر';
                    sendButton.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-circle"></i> حدث خطأ في الاتصال
                    </div>
                `;
                sendButton.innerHTML = '<i class="fas fa-handshake"></i> إرسال عرض السعر';
                sendButton.disabled = false;
            });
        });
    }
    
    // Contact Seller functionality
    const sendContactButton = document.getElementById('sendContactMessage');
    const contactResult = document.getElementById('contactResult');
    
    if (sendContactButton) {
        sendContactButton.addEventListener('click', function() {
            const productId = document.getElementById('productId').value;
            const sellerId = document.getElementById('sellerId').value;
            const buyerName = document.getElementById('buyerName').value.trim();
            const buyerEmail = document.getElementById('buyerEmail').value.trim();
            const messageText = document.getElementById('messageText').value.trim();
            
            // Validation
            if (!buyerName || !buyerEmail || !messageText) {
                contactResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> يرجى ملء جميع الحقول
                    </div>
                `;
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(buyerEmail)) {
                contactResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> يرجى إدخال بريد إلكتروني صحيح
                    </div>
                `;
                return;
            }
            
            // Disable button during request
            sendContactButton.disabled = true;
            sendContactButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
            
            // Use unified send_message endpoint
            fetch('/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    receiver_id: sellerId,
                    product_id: productId,
                    content: messageText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    contactResult.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> ✅ تم إرسال رسالتك إلى البائع بنجاح!
                        </div>
                    `;
                    // Clear form
                    document.getElementById('contactSellerForm').reset();
                    // Auto-close modal after 3 seconds
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('contactSellerModal'));
                        if (modal) modal.hide();
                    }, 3000);
                } else {
                    contactResult.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> ${data.message}
                        </div>
                    `;
                }
                
                sendContactButton.innerHTML = '<i class="fas fa-paper-plane"></i> إرسال الرسالة';
                sendContactButton.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                contactResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> حدث خطأ في الاتصال، يرجى المحاولة مرة أخرى
                    </div>
                `;
                sendContactButton.innerHTML = '<i class="fas fa-paper-plane"></i> إرسال الرسالة';
                sendContactButton.disabled = false;
            });
        });
    }

    // ========================
    // 💬 Real-Time Chat System
    // ========================
    
    let chatRefreshInterval;
    let lastMessageId = 0;
    
    window.openChatBox = function() {
        const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
        chatModal.show();
        loadChatHistory();
        startChatRefresh();
    };
    
    function loadChatHistory() {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '<div class="chat-loading"><i class="fas fa-spinner fa-spin"></i> جاري تحميل المحادثة...</div>';
        
        fetch(`/get_messages/{{ product.id }}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayChatMessages(data.messages);
                    if (data.messages.length > 0) {
                        lastMessageId = Math.max(...data.messages.map(m => m.id));
                    }
                } else {
                    chatMessages.innerHTML = '<div class="alert alert-danger">حدث خطأ في تحميل المحادثة</div>';
                }
            })
            .catch(error => {
                console.error('Chat history error:', error);
                chatMessages.innerHTML = '<div class="alert alert-danger">فشل في الاتصال بالخادم</div>';
            });
    }
    
    function displayChatMessages(messages) {
        const chatMessages = document.getElementById('chatMessages');
        
        if (messages.length === 0) {
            chatMessages.innerHTML = '<div class="no-messages">لا توجد رسائل بعد. ابدأ المحادثة!</div>';
            return;
        }
        
        let messagesHtml = '';
        messages.forEach(message => {
            const messageClass = message.is_own_message ? 'own-message' : 'other-message';
            const senderLabel = message.sender_type === 'seller' ? 'البائع' : 'المشتري';
            
            messagesHtml += `
                <div class="chat-message ${messageClass}">
                    <div class="message-bubble">
                        <div class="message-text">${escapeHtml(message.message)}</div>
                        <div class="message-meta">
                            ${message.is_own_message ? 'أنت' : senderLabel} • ${message.timestamp}
                        </div>
                    </div>
                </div>
            `;
        });
        
        chatMessages.innerHTML = messagesHtml;
        scrollToBottom();
    }
    
    function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function sendChatMessage() {
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendChatMessage');
        const message = chatInput.value.trim();
        
        if (!message) return;
        
        // Disable input during send
        chatInput.disabled = true;
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        const payload = {
            product_id: {{ product.id }},
            message: message
        };
        
        {% if current_user.id == product.user_id %}
        // If current user is seller, need buyer_id for reply
        // This would need to be determined from chat context
        // For now, we'll let the backend handle it
        {% endif %}
        
        // Use unified send_message endpoint
        fetch('/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                receiver_id: {{ product.user_id }}, // Send to product owner (seller)
                product_id: {{ product.id }},
                content: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add message to chat immediately
                addMessageToChat(data.chat_message);
                chatInput.value = '';
                scrollToBottom();
            } else {
                alert('فشل في إرسال الرسالة: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Send message error:', error);
            alert('حدث خطأ في الاتصال');
        })
        .finally(() => {
            // Re-enable input
            chatInput.disabled = false;
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            chatInput.focus();
        });
    }
    
    function addMessageToChat(message) {
        const chatMessages = document.getElementById('chatMessages');
        
        // Remove "no messages" placeholder if exists
        if (chatMessages.querySelector('.no-messages')) {
            chatMessages.innerHTML = '';
        }
        
        const messageClass = message.is_own_message ? 'own-message' : 'other-message';
        const senderLabel = 'أنت';
        
        const messageHtml = `
            <div class="chat-message ${messageClass}">
                <div class="message-bubble">
                    <div class="message-text">${escapeHtml(message.message)}</div>
                    <div class="message-meta">
                        ${senderLabel} • ${message.timestamp}
                    </div>
                </div>
            </div>
        `;
        
        chatMessages.insertAdjacentHTML('beforeend', messageHtml);
        lastMessageId = message.id;
    }
    
    function startChatRefresh() {
        // Refresh chat every 5 seconds
        chatRefreshInterval = setInterval(() => {
            refreshChatMessages();
        }, 5000);
    }
    
    function refreshChatMessages() {
        fetch(`/get_messages/{{ product.id }}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.messages.length > 0) {
                    const latestMessageId = Math.max(...data.messages.map(m => m.id));
                    if (latestMessageId > lastMessageId) {
                        // New messages arrived
                        displayChatMessages(data.messages);
                        lastMessageId = latestMessageId;
                    }
                }
            })
            .catch(error => {
                console.error('Chat refresh error:', error);
            });
    }
    
    // Event listeners for chat
    document.getElementById('sendChatMessage').addEventListener('click', sendChatMessage);
    
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });
    
    // Stop refresh when modal is closed
    document.getElementById('chatModal').addEventListener('hidden.bs.modal', function() {
        if (chatRefreshInterval) {
            clearInterval(chatRefreshInterval);
        }
    });
    
    // ========================
    // 💬 Live Chat Function
    // ========================
    
    window.openLiveChat = function() {
        const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
        chatModal.show();
        loadChatHistory();
        startChatRefresh();
    };
});

// ========================
// 💬 Chat System for Product Page
// ========================

function toggleChat() {
    const chatContainer = document.getElementById('chatContainer');
    if (chatContainer.style.display === 'none') {
        chatContainer.style.display = 'block';
        loadChatMessages();
        startChatRefresh();
    } else {
        chatContainer.style.display = 'none';
        stopChatRefresh();
    }
}

let productChatRefreshInterval;

function loadChatMessages() {
    const productId = document.getElementById('productId') ? document.getElementById('productId').value : null;
    if (!productId) return;
    
    fetch(`/get_messages/${productId}`)
        .then(response => response.json())
        .then(messages => {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            chatMessages.innerHTML = '';
            
            if (!messages || messages.length === 0) {
                chatMessages.innerHTML = '<div class="no-messages"><i class="fas fa-comments"></i><br>لا توجد رسائل بعد<br><small>ابدأ المحادثة!</small></div>';
                return;
            }
            
            const currentUserId = {% if current_user.is_authenticated %}{{ current_user.id }}{% else %}null{% endif %};
            
            messages.forEach(msg => {
                const isCurrentUser = (msg.sender_id === currentUserId);
                const isSeller = msg.is_seller;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${isSeller ? 'seller' : 'buyer'}`;
                bubble.innerHTML = `
                    <div class="message-sender">${escapeHtml(msg.sender_name)}</div>
                    <div class="message-content">${escapeHtml(msg.content)}</div>
                    <div class="message-time">${msg.timestamp}</div>
                `;
                
                messageDiv.appendChild(bubble);
                chatMessages.appendChild(messageDiv);
            });
            
            // التمرير لآخر رسالة
            chatMessages.scrollTop = chatMessages.scrollHeight;
        })
        .catch(error => {
            console.error('Error loading messages:', error);
        });
}

function startChatRefresh() {
    productChatRefreshInterval = setInterval(loadChatMessages, 5000); // تحديث كل 5 ثواني
}

function stopChatRefresh() {
    if (productChatRefreshInterval) {
        clearInterval(productChatRefreshInterval);
    }
}

// إرسال رسالة جديدة في صفحة المنتج
document.addEventListener('DOMContentLoaded', function() {
    const sendButton = document.getElementById('sendMessageBtn');
    if (sendButton) {
        sendButton.addEventListener('click', function() {
            const content = document.getElementById('messageContent').value;
            const productId = document.getElementById('productId').value;
            const sellerId = document.getElementById('sellerId').value;
            
            if (content.trim() === '') return;
            
            const formData = new FormData();
            formData.append('receiver_id', sellerId);
            formData.append('product_id', productId);
            formData.append('content', content);
            
            fetch('/send_message', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('messageContent').value = '';
                    loadChatMessages();
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
            });
        });
    }
});

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

</script>
{% endblock %}
